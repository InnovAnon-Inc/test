name: Autotools CI

on:
  push:
    branches: [ "cmake" ]
  pull_request:
    branches: [ "cmake" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      #with:
        #submodules: true
        #fetch-depth: 0
    - uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: check doxygen Ninja
        version: 1.0

    - name: configure
      run: cmake -S . -B build -GNinja

    - name: build
      run: cmake --build build

    - name: unit test
      run: cmake --build build --target test

    - name: docs
      run: cmake --build build --target docs

    #- name: make distcheck
    #  run: make distcheck

    - name: deploy docs to gh-pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/cmake'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/docs

    #TODO docs / GitHub pages

#    - name: dist
#      run: make dist
#
#    - name: extract
#      run: tar xf test-1.0.0.tar.gz
#
#    # integration test
#    - name: configure 2
#      run: |
#        cd test-1.0.0
#        ./configure
#    - name: make
#      run: |
#        cd test-1.0.0
#        make
#    - name: install
#      run: |
#        cd test-1.0.0
#        t=$(mktemp -d) || exit
#        DESTDIR=$t make install

    - name: Bump version and push tag
      id: tag_version
      uses: mathieudutour/github-tag-action@v6.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}

#    - name: Create a GitHub release
#      uses: ncipollo/release-action@v1
#      with:
#        tag: ${{ steps.tag_version.outputs.new_tag }}
#        name: Release ${{ steps.tag_version.outputs.new_tag }}
#        body: ${{ steps.tag_version.outputs.changelog }}
#
#    - name: Release
#      uses: softprops/action-gh-release@v1
#      #if: startsWith(github.ref, 'refs/tags/')
#      with:
#        files: test-1.0.0.tar.gz


